---
- name: download etcd binary tar.gz file
  become: true
  get_url:
    url: https://github.com/etcd-io/etcd/releases/download/{{ ETCD_VER }}/etcd-{{ ETCD_VER }}-linux-amd64.tar.gz
    dest: /opt/etcd-{{ ETCD_VER }}-linux-amd64.tar.gz
    timeout: 250
    backup: yes
    mode: 0440
  tags: [ get_etcd ]

- name: extract etcd .tar.gz file
  become: true
  unarchive:
    src: /opt/etcd-{{ ETCD_VER }}-linux-amd64.tar.gz
    dest: /opt
    remote_src: yes
  tags: [ get_etcd ]

- name: stat etcd
  become: true
  stat: 
    path: /opt/etcd-{{ ETCD_VER }}-linux-amd64/etcd
  register: etcd_file_stat
  tags: [ install_etcd ]

- name: move etcd and etcdctl to /usr/local/bin/
  become: true
  copy:
    src: /opt/etcd-{{ ETCD_VER }}-linux-amd64/{{ item.name }}
    dest: /usr/local/bin/{{ item.name }}
    mode: 0777
    remote_src: yes
  loop:
    - { name: etcd }
    - { name: etcdctl }
  when: etcd_file_stat.stat.exists
  tags: [ install_etcd ]

- name: remove etcd donload file directory and .tar.gz in `/opt` directory
  become: true
  file:
    path: '/opt/{{ item }}'
    state: absent
  loop:
    - etcd-{{ ETCD_VER }}-linux-amd64
    - etcd-{{ ETCD_VER }}-linux-amd64.tar.gz
  tags: [ install_etcd ]